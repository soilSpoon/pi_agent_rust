name: ci

on:
  pull_request:
  push:
    branches: [main]

jobs:
  rust:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      CI: "true"
      VCR_MODE: "playback"
      VCR_CASSETTE_DIR: "tests/fixtures/vcr"
      RUST_BACKTRACE: "1"
    defaults:
      run:
        working-directory: pi_agent_rust
        shell: bash
    steps:
      - name: Checkout pi_agent_rust
        uses: actions/checkout@v4
        with:
          path: pi_agent_rust

      - name: Install system deps (fd, rg) [linux]
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y fd-find ripgrep
          sudo ln -sf "$(command -v fdfind)" /usr/local/bin/fd

      - name: Install system deps (fd, rg) [macos]
        if: runner.os == 'macOS'
        run: |
          set -euxo pipefail
          brew install fd ripgrep

      - name: Install system deps (fd, rg) [windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y fd ripgrep

      - name: Install Rust toolchain (nightly)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install cargo-llvm-cov
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: No-mock dependency guard
        run: |
          set -euxo pipefail
          if rg -n --fixed-strings -e mockall -e mockito -e wiremock Cargo.toml Cargo.lock; then
            echo "Mocking crates are forbidden in dependencies."
            exit 1
          fi

      - name: No-mock code guard
        run: |
          set -euxo pipefail

          # Allowlisted exceptions (audited):
          # - MockHttp{Server,Request,Response}: deterministic local TCP server test infra.
          allow_re='^(MockHttp(Server|Request|Response))$'

          matches="$(rg -n --column --no-heading --color never -o '\b(Mock|Fake|Stub)[A-Za-z0-9_]+\b' tests || true)"
          if [ -z "$matches" ]; then
            exit 0
          fi

          violations="$(echo "$matches" | awk -F: -v allow_re="$allow_re" '$4 !~ allow_re { print }')"
          if [ -n "$violations" ]; then
            echo "$violations"
            echo
            echo "No-mock policy violation: Mock*/Fake*/Stub* identifiers are forbidden in tests."
            echo "Use VCR fixtures or real deps instead. See docs/TEST_COVERAGE_MATRIX.md."
            exit 1
          fi

      - name: Suite classification guard
        run: |
          set -euo pipefail
          # Every tests/*.rs file must appear in tests/suite_classification.toml.
          # Subdirectories (common/, provider_streaming/, conformance/, ext_conformance/) are excluded.
          classification="tests/suite_classification.toml"
          if [ ! -f "$classification" ]; then
            echo "Missing $classification â€” see docs/testing-policy.md"
            exit 1
          fi

          missing=0
          for f in tests/*.rs; do
            stem="$(basename "$f" .rs)"
            if ! rg -q --fixed-strings "\"$stem\"" "$classification"; then
              echo "UNCLASSIFIED: $f is not listed in $classification"
              missing=$((missing + 1))
            fi
          done

          if [ "$missing" -gt 0 ]; then
            echo
            echo "Suite classification violation: $missing test file(s) missing from $classification."
            echo "Add each file to [suite.unit], [suite.vcr], or [suite.e2e]. See docs/testing-policy.md."
            exit 1
          fi
          echo "All test files classified."

      - name: VCR leak guard (unit suite)
        run: |
          set -euo pipefail
          classification="tests/suite_classification.toml"

          # Extract unit suite file names.
          unit_files="$(sed -n '/\[suite\.unit\]/,/\[suite\./{ /^files/,/\]/p }' "$classification" \
            | rg -o '"([^"]+)"' -r '$1' || true)"

          if [ -z "$unit_files" ]; then
            echo "No unit suite files found; skipping VCR leak check."
            exit 0
          fi

          violations=0
          for stem in $unit_files; do
            f="tests/${stem}.rs"
            [ -f "$f" ] || continue
            if rg -q 'VcrRecorder|VcrMode|cassette_root|cassette_dir|fixtures/vcr' "$f"; then
              echo "VCR LEAK: $f is in suite.unit but references VCR infrastructure."
              violations=$((violations + 1))
            fi
          done

          if [ "$violations" -gt 0 ]; then
            echo
            echo "VCR leak violation: $violations unit-suite file(s) reference VCR."
            echo "Move to [suite.vcr] or remove VCR usage. See docs/testing-policy.md."
            exit 1
          fi
          echo "No VCR leaks in unit suite."

      - name: cargo fmt
        run: cargo fmt --check

      - name: cargo clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: cargo clippy (wasm-host) [linux]
        if: runner.os == 'Linux'
        run: cargo clippy --all-targets --features wasm-host -- -D warnings

      - name: cargo doc
        run: cargo doc --no-deps

      - name: cargo test
        run: cargo test --all-targets

      - name: cargo test (wasm-host) [linux]
        if: runner.os == 'Linux'
        run: cargo test --all-targets --features wasm-host

      - name: Coverage summary (llvm-cov)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          start=$(date +%s)
          echo "env: CI=$CI VCR_MODE=$VCR_MODE VCR_CASSETTE_DIR=$VCR_CASSETTE_DIR"
          cargo llvm-cov --all-targets --workspace --summary-only | tee llvm-cov-summary.txt
          end=$(date +%s)
          echo "coverage_summary_duration_s=$((end-start))"

      - name: Coverage gate (lcov)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          start=$(date +%s)
          # Coverage gate: 50% (actual: ~66% as of 2026-02-05)
          cargo llvm-cov --all-targets --workspace --lcov --output-path lcov.info --fail-under-lines 50
          ls -lah lcov.info
          end=$(date +%s)
          echo "coverage_lcov_duration_s=$((end-start))"

      - name: Coverage report (html)
        if: runner.os == 'Linux'
        run: cargo llvm-cov --all-targets --workspace --html

      - name: Upload coverage artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            pi_agent_rust/llvm-cov-summary.txt
            pi_agent_rust/lcov.info
            pi_agent_rust/target/llvm-cov/html

      - name: Upload conformance reports
        if: runner.os == 'Linux' && always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-reports
          path: |
            pi_agent_rust/tests/ext_conformance/reports/**/*.json
            pi_agent_rust/tests/ext_conformance/reports/**/*.jsonl
          if-no-files-found: ignore
